CREATE EXTENSION pg_dms CASCADE;
NOTICE:  installing required extension "uuid-ossp"
--
--  Создание таблицы справочник
--
CREATE TABLE public.directory (
  KEY pg_dms_id NOT NULL DEFAULT uuid_generate_v4(),
  num integer,
  CONSTRAINT d_pkey PRIMARY KEY (KEY)
)
WITH (OIDS = FALSE) TABLESPACE pg_default;
--
--  Вставка значений по умочанию
--
-- Закоментировать - будут вставлены случайные ключи
--INSERT INTO public.directory (num) VALUES (1);
--INSERT INTO public.directory (num)  VALUES (2);
--
--  Вставка заначений в виде pg_dms_id
--
INSERT INTO public.directory (KEY, num)
  VALUES (('73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a')::pg_dms_id, 3);
--
--  Вставка заначений в виде строки
--
INSERT INTO public.directory (KEY, num)
  VALUES ('3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6', 4);
INSERT INTO public.directory (KEY, num)
  VALUES ('ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf', 5);
INSERT INTO public.directory (KEY, num)
  VALUES ('ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8', 6);
INSERT INTO public.directory (KEY, num)
  VALUES ('ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff', 8);
--
--  Создание новой версии строки
--
INSERT INTO public.directory (KEY, num)
  VALUES (pg_dms_createversion(('ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff')::pg_dms_id,
          '6e108955-7aff-4a9c-871c-a41fb8006594'::uuid), 7);
--
--  Просмотр результата создания таблицы
--
SELECT * FROM directory order by key;
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6 |   4
 73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a |   3
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
(6 rows)

--
--  Поиск записей по различным условиям
--
SELECT * FROM directory WHERE key > '73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a';
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
(4 rows)

SELECT * FROM directory WHERE key >= '73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a';
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a |   3
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
(5 rows)

SELECT * FROM directory WHERE key = '73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a';
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a |   3
(1 row)

SELECT * FROM directory WHERE key < '73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a';
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6 |   4
(1 row)

SELECT * FROM directory WHERE key <= '73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a';
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a |   3
 3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6 |   4
(2 rows)

--
--  Добавление действия со строкой
--
UPDATE directory SET key=pg_dms_setaction(key, 100, (SELECT oid FROM pg_class WHERE relname = 'directory'), '73a0d05a-d681-4bb3-9e31-9f52ee938ad2'::uuid) WHERE num = 3;
--
--  Получение статуса строки
--
SELECT pg_dms_getstatus(key), num FROM directory;
 pg_dms_getstatus | num 
------------------+-----
                0 |   4
                0 |   5
                0 |   6
                0 |   8
                0 |   7
              100 |   3
(6 rows)

--Закоментировать - возвращается текущая дата
--SELECT pg_dms_getaction(key), num FROM directory;
--
--  Просмот действий со строкой в виде таблицы
--
--Закоментировать - возвращается текущая дата
--SELECT a.name, au.rolname, "date", c.relname, reason_key FROM unnest((SELECT pg_dms_getaction(key) FROM directory WHERE num = 3) ) AS t
--LEFT JOIN action_list a ON t.type = a.key 
--LEFT JOIN pg_catalog.pg_authid au ON t.user = au.oid
--LEFT JOIN pg_catalog.pg_class c ON t.reason = c.oid;
--
--  Поиск в таблице по значению uuid
--
SELECT * FROM directory WHERE  'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid = key;
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
(4 rows)

SELECT * FROM directory WHERE  'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid < key;
 key | num 
-----+-----
(0 rows)

SELECT * FROM directory WHERE  'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid <= key;
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
(4 rows)

SELECT * FROM directory WHERE  'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid > key;
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6 |   4
 73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a |   3
(2 rows)

SELECT * FROM directory WHERE  'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid >= key;
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6 |   4
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
 73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a |   3
(6 rows)

SELECT * FROM directory WHERE  key = 'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid;
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
(4 rows)

SELECT * FROM directory WHERE  key < 'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid;
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6 |   4
 73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a |   3
(2 rows)

SELECT * FROM directory WHERE  key <= 'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid;
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6 |   4
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
 73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a |   3
(6 rows)

SELECT * FROM directory WHERE  key > 'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid;
 key | num 
-----+-----
(0 rows)

SELECT * FROM directory WHERE  key >= 'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid;
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
(4 rows)

--
--  Создание таблицы в которой есть ссылка на семейство записей в таблице справочника
--
CREATE TABLE public.family (
  KEY integer NOT NULL,
  directory_key pg_dms_family,
  name text,
  CONSTRAINT family_pkey PRIMARY KEY (KEY),
  CONSTRAINT family_directory_fkey FOREIGN KEY (directory_key) REFERENCES public.directory (KEY)
)
  WITH (OIDS = FALSE) TABLESPACE pg_default;
--
--  Добавление записи в таблицу со ссылкий на справочник
--
INSERT INTO public.family (key, directory_key, name) VALUES (1, 'ae060476-a0c1-4ec1-993f-f71ba3882796','a1');
--
--  Просмотр результата вставки
--
SELECT * FROM public.family LEFT JOIN  public.directory ON family.directory_key = directory.key;
 key |            directory_key             | name |                                    key                                    | num 
-----+--------------------------------------+------+---------------------------------------------------------------------------+-----
   1 | ae060476-a0c1-4ec1-993f-f71ba3882796 | a1   | ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
   1 | ae060476-a0c1-4ec1-993f-f71ba3882796 | a1   | ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
   1 | ae060476-a0c1-4ec1-993f-f71ba3882796 | a1   | ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
   1 | ae060476-a0c1-4ec1-993f-f71ba3882796 | a1   | ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
(4 rows)

--
--  Создание таблицы в которой есть ссылка на записи в таблице справочника
--
CREATE TABLE public.ref (
  KEY integer NOT NULL,
  directory_key pg_dms_ref,
  name text,
  CONSTRAINT ref_pkey PRIMARY KEY (KEY),
  CONSTRAINT ref_directory_fkey FOREIGN KEY (directory_key) REFERENCES public.directory (KEY)
)
  WITH (OIDS = FALSE) TABLESPACE pg_default;
--
--  Добавление записи в таблицу со ссылкий на справочник
--
INSERT INTO public.ref (key, directory_key, name) VALUES (1, 'ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf','a1');
--
--  Просмотр результата вставки
--
SELECT * FROM public.ref LEFT JOIN  public.directory ON ref.directory_key = directory.key;
 key |                               directory_key                               | name |                                    key                                    | num 
-----+---------------------------------------------------------------------------+------+---------------------------------------------------------------------------+-----
   1 | ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf | a1   | ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
(1 row)

/*
Не создается CONSTRAINT 
ERROR:  foreign key constraint "test_uuid_directory_fkey" cannot be implemented
DETAIL:  Key columns "directory_key" and "key" are of incompatible types: uuid and pg_dms_id.

CREATE TABLE public.test_uuid (
  KEY integer NOT NULL,
  directory_key uuid,
  name text,
  CONSTRAINT test_uuid_pkey PRIMARY KEY (KEY),
  CONSTRAINT test_uuid_directory_fkey FOREIGN KEY (directory_key) REFERENCES public.directory (KEY)
)
  WITH (OIDS = FALSE) TABLESPACE pg_default;
--
--  Добавление записи в таблицу со ссылкий на справочник
--
INSERT INTO public.ref (key, directory_key, name) VALUES (1, 'ae060476-a0c1-4ec1-993f-f71ba3882796','a1');
--
--  Просмотр результата вставки
--
SELECT * FROM public.ref LEFT JOIN  public.directory ON ref.directory_key = directory.key;
*/
--
--  Расчет JSON
--
-- Закомментировано, потому что возвращается текущее время
--select pg_dms_getjson(directory, key) from directory;
--
--  Расчет хеш строк
--
select pg_dms_gethash(directory, key) from directory;
            pg_dms_gethash            
--------------------------------------
 aa921482-d2b5-a850-9467-d96fd1ad3e9a
 1a2d93fe-ade4-6959-feb6-66c71986b1e9
 0851ea1b-7391-e8ae-4a94-f08022b817f0
 7279c86f-c980-1f30-497c-ddc5d38e1b54
 9919cb5c-1938-e801-4f17-3f55aa69ce45
 03be4384-a9ec-be36-45e1-d917066b2ba9
(6 rows)

--
--  Расчет строк для хеш 
--
select pg_dms_getstringforhash(directory, key) from directory;
                          pg_dms_getstringforhash                           
----------------------------------------------------------------------------
 3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca64
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa86
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff8
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb80065947
 73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a3
(6 rows)

