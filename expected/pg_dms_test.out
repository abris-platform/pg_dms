CREATE EXTENSION pg_dms CASCADE;
NOTICE:  installing required extension "uuid-ossp"
--
--  Создание таблицы справочник
--
CREATE TABLE public.directory (
  KEY pg_dms_id NOT NULL DEFAULT uuid_generate_v4(),
  num integer,
  CONSTRAINT d_pkey PRIMARY KEY (KEY)
)
WITH (OIDS = FALSE) TABLESPACE pg_default;
--
--  Вставка значений по умочанию
--
-- Закоментировать - будут вставлены случайные ключи
--INSERT INTO public.directory (num) VALUES (1);
--INSERT INTO public.directory (num)  VALUES (2);
--
--  Вставка заначений в виде pg_dms_id
--
INSERT INTO public.directory (KEY, num)
  VALUES (('73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a')::pg_dms_id, 3);
--
--  Вставка заначений в виде строки
--
INSERT INTO public.directory (KEY, num)
  VALUES ('3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6', 4);
INSERT INTO public.directory (KEY, num)
  VALUES ('ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf', 5);
INSERT INTO public.directory (KEY, num)
  VALUES ('ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8', 6);
INSERT INTO public.directory (KEY, num)
  VALUES ('ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff', 8);
--
--  Создание новой версии строки
--
INSERT INTO public.directory (KEY, num)
  VALUES (pg_dms_createversion(('ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff')::pg_dms_id,
          '6e108955-7aff-4a9c-871c-a41fb8006594'::uuid), 7);
--
--  Просмотр результата создания таблицы
--
SELECT * FROM directory order by key;
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6 |   4
 73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a |   3
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
(6 rows)

--
--  Поиск записей по различным условиям
--
SELECT * FROM directory WHERE key > '73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a';
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
(4 rows)

SELECT * FROM directory WHERE key >= '73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a';
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a |   3
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
(5 rows)

SELECT * FROM directory WHERE key = '73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a';
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a |   3
(1 row)

SELECT * FROM directory WHERE key < '73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a';
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6 |   4
(1 row)

SELECT * FROM directory WHERE key <= '73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a';
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a |   3
 3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6 |   4
(2 rows)

--
--  Добавление действия со строкой
--
UPDATE directory SET key=pg_dms_setaction(key, 100, (SELECT oid FROM pg_class WHERE relname = 'directory'), '73a0d05a-d681-4bb3-9e31-9f52ee938ad2'::uuid) WHERE num = 3;
UPDATE directory SET key=pg_dms_setaction(key, 200, (SELECT oid FROM pg_class WHERE relname = 'directory'), '73a0d05a-d681-4bb3-9e31-9f52ee938ad2'::uuid) WHERE num = 3;
--
--  Получение статуса строки
--
SELECT pg_dms_getstatus(key), num FROM directory;
 pg_dms_getstatus | num 
------------------+-----
                0 |   4
                0 |   5
                0 |   6
                0 |   8
                0 |   7
              200 |   3
(6 rows)

--Закоментировать - возвращается текущая дата
--SELECT pg_dms_getaction(key), num FROM directory;
--
--  Просмот действий со строкой в виде таблицы
--
--Закоментировать - возвращается текущая дата
-- SELECT a.name, au.rolname, "date", c.relname, reason_key FROM unnest((SELECT pg_dms_getaction(key) FROM directory WHERE num = 3) ) AS t
-- LEFT JOIN action_list a ON t.type = a.key 
-- LEFT JOIN pg_catalog.pg_authid au ON t.user = au.oid
-- LEFT JOIN pg_catalog.pg_class c ON t.reason = c.oid;
--
--  Поиск в таблице по значению uuid
--
SELECT * FROM directory WHERE  'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid = key;
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
(4 rows)

SELECT * FROM directory WHERE  'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid < key;
 key | num 
-----+-----
(0 rows)

SELECT * FROM directory WHERE  'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid <= key;
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
(4 rows)

SELECT * FROM directory WHERE  'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid > key;
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6 |   4
 73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a |   3
(2 rows)

SELECT * FROM directory WHERE  'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid >= key;
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6 |   4
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
 73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a |   3
(6 rows)

SELECT * FROM directory WHERE  key = 'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid;
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
(4 rows)

SELECT * FROM directory WHERE  key < 'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid;
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6 |   4
 73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a |   3
(2 rows)

SELECT * FROM directory WHERE  key <= 'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid;
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6 |   4
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
 73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a |   3
(6 rows)

SELECT * FROM directory WHERE  key > 'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid;
 key | num 
-----+-----
(0 rows)

SELECT * FROM directory WHERE  key >= 'ae060476-a0c1-4ec1-993f-f71ba3882796'::uuid;
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
(4 rows)

--
--  Создание таблицы в которой есть ссылка на семейство записей в таблице справочника
--
CREATE TABLE public.family (
  KEY integer NOT NULL,
  directory_key pg_dms_family,
  name text,
  CONSTRAINT family_pkey PRIMARY KEY (KEY),
  CONSTRAINT family_directory_fkey FOREIGN KEY (directory_key) REFERENCES public.directory (KEY)
)
  WITH (OIDS = FALSE) TABLESPACE pg_default;
--
--  Добавление записи в таблицу со ссылкий на справочник
--
INSERT INTO public.family (key, directory_key, name) VALUES (1, 'ae060476-a0c1-4ec1-993f-f71ba3882796','a1');
--
--  Просмотр результата вставки
--
SELECT * FROM public.family LEFT JOIN  public.directory ON family.directory_key = directory.key;
 key |            directory_key             | name |                                    key                                    | num 
-----+--------------------------------------+------+---------------------------------------------------------------------------+-----
   1 | ae060476-a0c1-4ec1-993f-f71ba3882796 | a1   | ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
   1 | ae060476-a0c1-4ec1-993f-f71ba3882796 | a1   | ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
   1 | ae060476-a0c1-4ec1-993f-f71ba3882796 | a1   | ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
   1 | ae060476-a0c1-4ec1-993f-f71ba3882796 | a1   | ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
(4 rows)

--
--  Создание таблицы в которой есть ссылка на записи в таблице справочника
--
CREATE TABLE public.ref (
  KEY integer NOT NULL,
  directory_key pg_dms_ref,
  name text,
  CONSTRAINT ref_pkey PRIMARY KEY (KEY),
  CONSTRAINT ref_directory_fkey FOREIGN KEY (directory_key) REFERENCES public.directory (KEY)
)
  WITH (OIDS = FALSE) TABLESPACE pg_default;
--
--  Добавление записи в таблицу со ссылкий на справочник
--
INSERT INTO public.ref (key, directory_key, name) VALUES (1, 'ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf','a1');
--
--  Просмотр результата вставки
--
SELECT * FROM public.ref LEFT JOIN  public.directory ON ref.directory_key = directory.key;
 key |                               directory_key                               | name |                                    key                                    | num 
-----+---------------------------------------------------------------------------+------+---------------------------------------------------------------------------+-----
   1 | ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf | a1   | ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
(1 row)

/*
Не создается CONSTRAINT 
ERROR:  foreign key constraint "test_uuid_directory_fkey" cannot be implemented
DETAIL:  Key columns "directory_key" and "key" are of incompatible types: uuid and pg_dms_id.

CREATE TABLE public.test_uuid (
  KEY integer NOT NULL,
  directory_key uuid,
  name text,
  CONSTRAINT test_uuid_pkey PRIMARY KEY (KEY),
  CONSTRAINT test_uuid_directory_fkey FOREIGN KEY (directory_key) REFERENCES public.directory (KEY)
)
  WITH (OIDS = FALSE) TABLESPACE pg_default;
--
--  Добавление записи в таблицу со ссылкий на справочник
--
INSERT INTO public.ref (key, directory_key, name) VALUES (1, 'ae060476-a0c1-4ec1-993f-f71ba3882796','a1');
--
--  Просмотр результата вставки
--
SELECT * FROM public.ref LEFT JOIN  public.directory ON ref.directory_key = directory.key;
*/
--
--  Расчет JSON
--
-- Закомментировано, потому что возвращается текущее время
--select pg_dms_getjson(directory, key) from directory;
--
--  Расчет хеш строк
--
--Закоментировать - возвращается текущая дата
-- select pg_dms_gethash(directory, key),num from directory;
--
--  Расчет строк для хеш 
--
--Закоментировать - возвращается текущая дата
-- select pg_dms_getstringforhash(directory, key) from directory;
--
--  Добавление хеша в ключ 
--
UPDATE directory SET key = pg_dms_setHash(directory, key) WHERE num = 3;
--Закоментировать - возвращается текущая дата
-- SELECT a.name, au.rolname, "date", c.relname, reason_key FROM unnest((SELECT pg_dms_getaction(key) FROM directory WHERE num = 3) ) AS t
-- LEFT JOIN action_list a ON t.type = a.key 
-- LEFT JOIN pg_catalog.pg_authid au ON t.user = au.oid
-- LEFT JOIN pg_catalog.pg_class c ON t.reason = c.oid;
--
--  Проверяет хеш 
--
--Закоментировать - возвращается текущая дата
-- select pg_dms_checkhash(directory, key), num from directory;
--
--  Добавление записи из json 
--
SELECT pf_dms_insert_from_json('{"schema": "public", "table": "directory", "key": "f723f29c-5dd3-4a45-a436-dc5076877c11,581c1426-e76a-4654-a23b-b948cd96453b", "columns": [{"name": "key", "type": "pg_dms_id", "value": "f723f29c-5dd3-4a45-a436-dc5076877c11,581c1426-e76a-4654-a23b-b948cd96453b"}, {"name": "num", "type": "int4", "value": "45"}], "actions": [{"type": 0, "user": 10, "date": "2018-04-29 02:47:54.911326-07"}]}'::json);
 pf_dms_insert_from_json 
-------------------------
 t
(1 row)

SELECT * FROM directory;
                                    key                                    | num 
---------------------------------------------------------------------------+-----
 3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6 |   4
 ae060476-a0c1-4ec1-993f-f71ba3882796,29a1e5f1-33f8-477b-958d-3868edfbbfcf |   5
 ae060476-a0c1-4ec1-993f-f71ba3882796,381adf5e-5ec2-4855-a25d-b22ef99fcfa8 |   6
 ae060476-a0c1-4ec1-993f-f71ba3882796,cc8a3b5b-9899-4038-ac01-67a6b0450eff |   8
 ae060476-a0c1-4ec1-993f-f71ba3882796,6e108955-7aff-4a9c-871c-a41fb8006594 |   7
 73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a |   3
 f723f29c-5dd3-4a45-a436-dc5076877c11,581c1426-e76a-4654-a23b-b948cd96453b |  45
(7 rows)

--
--  Добавление записи в реестр 
--
--SELECT pf_dms_insert_to_register('public', 'directory', 'key', key) FROM public.directory WHERE num = 3;
SELECT pf_dms_insert_to_register('public', 'directory', 'key', key) FROM public.directory WHERE num < 5;
 pf_dms_insert_to_register 
---------------------------
 t
 t
(2 rows)

SELECT count(*) FROM public.register;
 count 
-------
     2
(1 row)

SELECT a.name, au.rolname, c.relname FROM unnest((SELECT pg_dms_getaction(key) FROM directory WHERE num = 3) ) AS t
  LEFT JOIN action_list a ON t.type = a.key 
  LEFT JOIN pg_catalog.pg_authid au ON t.user = au.oid
  LEFT JOIN pg_catalog.pg_class c ON t.reason = c.oid;
        name         | rolname  |  relname  
---------------------+----------+-----------
 Создано             | postgres | 
 Проверено           | postgres | directory
 Утверждено          | postgres | directory
 Рассчитан хеш       | postgres | 
 Направлено в реестр | postgres | register
(5 rows)

SELECT get_status_rigister(key), num FROM  directory; 
 get_status_rigister | num 
---------------------+-----
                   0 |   5
                   0 |   6
                   0 |   8
                   0 |   7
                   0 |  45
                  -1 |   4
                  -1 |   3
(7 rows)

SELECT pf_dms_create_file();
 pf_dms_create_file 
--------------------
 t
(1 row)

SELECT * FROM  public.register_file;
                 key                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               file                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |              inserted               | status 
--------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------+--------
 c57432cc-2900-460f-97a6-7ea8e7df8af4 | {"records": [{"data": {"key": "3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6", "table": "directory", "schema": "public", "actions": [{"date": "2018-05-08 06:15:19.347154-07", "type": 0, "user": 10}], "columns": [{"name": "key", "type": "pg_dms_id", "value": "3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6"}, {"name": "num", "type": "int4", "value": "4"}]}, "local_key": "7bbf603a-53c7-48b6-99e7-1c235e78b5c2"}, {"data": {"key": "73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a", "table": "directory", "schema": "public", "actions": [{"date": "2018-05-08 06:15:19.344614-07", "type": 0, "user": 10}, {"date": "2018-05-08 06:15:19.355649-07", "type": 100, "user": 10}, {"date": "2018-05-08 06:15:19.357198-07", "type": 200, "user": 10}], "columns": [{"name": "key", "type": "pg_dms_id", "value": "73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a"}, {"name": "num", "type": "int4", "value": "3"}]}, "local_key": "d40e2083-4ffe-4901-9c33-a4ed5e0d7739"}]} | Tue May 08 06:15:19.391957 2018 PDT |      0
(1 row)

SELECT pf_dms_save_file((select key from register_file),  (select file from register_file), '75e56803-cb7e-4fcd-9767-ff6807774e4d');
 pf_dms_save_file 
------------------
 t
(1 row)

SELECT * from public.global_register_file;
               key_file               |             ex_database              |                ex_key                |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ex_file                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |              inserted               |                                                                    out_file                                                                     | status 
--------------------------------------+--------------------------------------+--------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------+--------
 5c8bc0f4-714b-4efa-9d63-ec1ae0ee8971 | 75e56803-cb7e-4fcd-9767-ff6807774e4d | c57432cc-2900-460f-97a6-7ea8e7df8af4 | {"records": [{"data": {"key": "3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6", "table": "directory", "schema": "public", "actions": [{"date": "2018-05-08 06:15:19.347154-07", "type": 0, "user": 10}], "columns": [{"name": "key", "type": "pg_dms_id", "value": "3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6"}, {"name": "num", "type": "int4", "value": "4"}]}, "local_key": "7bbf603a-53c7-48b6-99e7-1c235e78b5c2"}, {"data": {"key": "73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a", "table": "directory", "schema": "public", "actions": [{"date": "2018-05-08 06:15:19.344614-07", "type": 0, "user": 10}, {"date": "2018-05-08 06:15:19.355649-07", "type": 100, "user": 10}, {"date": "2018-05-08 06:15:19.357198-07", "type": 200, "user": 10}], "columns": [{"name": "key", "type": "pg_dms_id", "value": "73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a"}, {"name": "num", "type": "int4", "value": "3"}]}, "local_key": "d40e2083-4ffe-4901-9c33-a4ed5e0d7739"}]} | Tue May 08 06:15:19.394224 2018 PDT | {"record" : [{"num": 2, "local_key": "7bbf603a-53c7-48b6-99e7-1c235e78b5c2"}, {"num": 3, "local_key": "d40e2083-4ffe-4901-9c33-a4ed5e0d7739"}]} |      0
(1 row)

SELECT * FROM public.global_register;
 num |                 salt                 |              hash-block              |                                                                                                                                                                                                                                                                     data                                                                                                                                                                                                                                                                      |              local_key               |               database               | schema_name | table_name |              inserted               
-----+--------------------------------------+--------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------+--------------------------------------+-------------+------------+-------------------------------------
   1 |                                      | c60bf311-445a-40a4-9b4b-32e308789e66 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                                      |                                      |             |            | Tue May 08 06:15:19.245427 2018 PDT
   2 | f0b3e1c7-193b-4d34-8d50-97a710475c1d | 00006ba2-3393-b0f1-2f78-2ab3954fdd62 | {"key": "3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6", "table": "directory", "schema": "public", "actions": [{"date": "2018-05-08 06:15:19.347154-07", "type": 0, "user": 10}], "columns": [{"name": "key", "type": "pg_dms_id", "value": "3ea227be-9932-4fb1-b47a-84c1851b419a,7cea1a82-213d-41aa-97f2-80138b538ca6"}, {"name": "num", "type": "int4", "value": "4"}]}                                                                                                                                         | 7bbf603a-53c7-48b6-99e7-1c235e78b5c2 | 75e56803-cb7e-4fcd-9767-ff6807774e4d | public      | directory  | Tue May 08 06:15:19.394224 2018 PDT
   3 | 91774fc9-ce63-4887-ab4b-cbc567fe9b8b | 00009734-a578-e0bf-0804-3875e0f26a86 | {"key": "73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a", "table": "directory", "schema": "public", "actions": [{"date": "2018-05-08 06:15:19.344614-07", "type": 0, "user": 10}, {"date": "2018-05-08 06:15:19.355649-07", "type": 100, "user": 10}, {"date": "2018-05-08 06:15:19.357198-07", "type": 200, "user": 10}], "columns": [{"name": "key", "type": "pg_dms_id", "value": "73a0d05a-d681-4bb3-9e31-9f52ee938ad2,eec4a453-4a90-49e9-8044-b6b51311ad5a"}, {"name": "num", "type": "int4", "value": "3"}]} | d40e2083-4ffe-4901-9c33-a4ed5e0d7739 | 75e56803-cb7e-4fcd-9767-ff6807774e4d | public      | directory  | Tue May 08 06:15:19.394224 2018 PDT
(3 rows)

UPDATE public.register SET status=1, ex_key='e0a0c1db-a4a0-4991-bdb4-f1f8ccf3df08', ex_inserted=now();
SELECT count(*) FROM public.register;
 count 
-------
     2
(1 row)

SELECT a.name, au.rolname, c.relname FROM unnest((SELECT pg_dms_getaction(key) FROM directory WHERE num = 3) ) AS t
  LEFT JOIN action_list a ON t.type = a.key 
  LEFT JOIN pg_catalog.pg_authid au ON t.user = au.oid
  LEFT JOIN pg_catalog.pg_class c ON t.reason = c.oid;
        name         | rolname  |  relname  
---------------------+----------+-----------
 Создано             | postgres | 
 Проверено           | postgres | directory
 Утверждено          | postgres | directory
 Рассчитан хеш       | postgres | 
 Направлено в реестр | postgres | register
 Добавлено в реестр  | postgres | register
(6 rows)

SELECT get_status_rigister(key), num FROM  directory; 
 get_status_rigister | num 
---------------------+-----
                   0 |   5
                   0 |   6
                   0 |   8
                   0 |   7
                   0 |  45
                   1 |   4
                   1 |   3
(7 rows)

